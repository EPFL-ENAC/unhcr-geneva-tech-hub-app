version: "3.9"

services:
  reverse-proxy:
    image: traefik:v2.9
    command:
      - "--providers.docker"
      - "--providers.file.directory=/configuration/"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      - "--entrypoints.web.http.redirections.entrypoint.permanent=true"
      - "--entrypoints.websecure.address=:443"
      - "--api.dashboard=true"
      - "--api.insecure=true"
    environment:
      - SSL_CERT_CRT=${SSL_CERT_CRT}
      - SSL_CERT_KEY=${SSL_CERT_KEY}
    ports:
      - "80:80"
      - "443:443"
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik.yaml:/configuration/traefik.yml
      - /etc/ssl:/etc/ssl
  nginx:
    image: nginx:latest
    expose:
      - "80"
    volumes:
      - ./default.conf.template:/etc/nginx/templates/default.conf.template
    env_file:
      - ./frontend/.env
    environment:
      - BASE_URL=${BASE_URL}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.priority=100"
      - "traefik.http.routers.frontend.tls=true"
      - "traefik.http.routers.frontend.rule=PathPrefix(`${BASE_URL}`)"
      - "traefik.http.routers.frontend.middlewares=frontend-stripprefix,compress"
      - "traefik.http.middlewares.compress.compress=true"
      - "traefik.http.middlewares.frontend-stripprefix.stripprefix.prefixes=${BASE_URL_WITHOUT_SLASH}"
    restart: unless-stopped
    depends_on:
      - reverse-proxy